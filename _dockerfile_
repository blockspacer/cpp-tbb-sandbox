
## install deps

### boost

WORKDIR /opt
RUN git clone --recursive --depth 1 https://github.com/boostorg/boost.git
WORKDIR /opt/boost
RUN ./bootstrap.sh
RUN ./b2 headers
RUN ./b2 install -j4  --without-mpi --without-python --disable-icu


### libwebrtc

WORKDIR /opt
RUN git clone --recursive --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
ENV PATH=$PATH:/opt/depot_tools

WORKDIR /opt/webrtc-checkout
RUN fetch --nohooks webrtc
WORKDIR /opt/webrtc-checkout/src
RUN git checkout -b libwebrtc59 refs/remotes/branch-heads/59
RUN gclient sync --with_branch_heads
RUN gn gen out/Release --args='rtc_use_h264=true rtc_use_lto=true'
RUN ninja -C out/Release

### ffmpeg

WORKDIR /opt
RUN git clone --recursive --depth 1 https://github.com/FFmpeg/FFmpeg.git
WORKDIR /opt/FFmpeg
RUN apt-get install -y --no-install-recommends \
  autoconf automake build-essential libass-dev libfreetype6-dev \
  libsdl2-dev libtheora-dev libtool libva-dev libvdpau-dev libvorbis-dev libxcb1-dev libxcb-shm0-dev \
  libxcb-xfixes0-dev pkg-config texinfo wget zlib1g-dev \
  yasm nasm \
  libx264-dev libmp3lame-dev libfdk-aac-dev \
  libvpx-dev libopus-dev
RUN env PKG_CONFIG_PATH=../../local/lib/pkgconfig ./configure \
  --enable-gpl \
  --enable-version3 \
  --enable-nonfree \
  \
  --enable-static \
  --disable-shared \
  --disable-doc \
  \
  --disable-ffplay \
  --disable-ffprobe \
  --disable-ffserver \
  \
  --enable-libass \
  --enable-libfdk-aac \
  --enable-libfreetype \
  --enable-libmp3lame \
  --enable-libopus \
  --enable-libvpx \
  --enable-libx264
RUN make -j4 && make install && hash -r


### libsourcey

WORKDIR /opt
RUN apt-get install -y ffmpeg
WORKDIR /opt
RUN git clone --recursive --depth 1 https://github.com/sourcey/libsourcey.git
WORKDIR /opt/libsourcey
RUN mkdir build
WORKDIR /opt/libsourcey/build
RUN cmake \
  -DCMAKE_INSTALL_PREFIX="/home/legokichi/Github/cpp_tbb/local/" \
  -DWEBRTC_ROOT_DIR="/home/legokichi/Github/cpp_tbb/third_party/webrtc-checkout/src/" \
  -DWEBRTC_INCLUDE_DIR="/home/legokichi/Github/cpp_tbb/third_party/webrtc-checkout/src/" \
  -DWEBRTC_ROOT_DIR="/opt/webrtc-checkout/src/" \
  -DCMAKE_BUILD_TYPE=RELEASE \
  -DBUILD_SHARED_LIBS=OFF \
  -DBUILD_MODULES=OFF \
  -DBUILD_APPLICATIONS=OFF \
  -DBUILD_SAMPLES=OFF \
  -DBUILD_TESTS=OFF \
  -DBUILD_MODULE_archo=ON \
  -DBUILD_MODULE_base=ON \
  -DBUILD_MODULE_crypto=ON \
  -DBUILD_MODULE_http=ON \
  -DBUILD_MODULE_json=ON \
  -DBUILD_MODULE_av=ON \
  -DBUILD_MODULE_net=ON \
  -DBUILD_MODULE_pacm=ON \
  -DBUILD_MODULE_pluga=ON \
  -DBUILD_MODULE_sked=ON \
  -DBUILD_MODULE_socketio=ON \
  -DBUILD_MODULE_stun=ON \
  -DBUILD_MODULE_symple=ON \
  -DBUILD_MODULE_turn=ON \
  -DBUILD_MODULE_util=ON \
  -DBUILD_MODULE_uv=ON \
  -DBUILD_MODULE_webrtc=ON \
  -DWITH_FFMPEG=OFF \
  -DWITH_OPENCV=OFF \
  -DWITH_WEBRTC=ON \
  ..
RUN make -j
RUN make install

